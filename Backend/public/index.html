<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√°mara IP IA - Transmisor</title>
    <style>
      body {
        background: #1a1a1a;
        color: #00ff00;
        font-family: monospace;
        text-align: center;
      }
      video,
      canvas {
        width: 100%;
        max-width: 500px;
        border: 1px solid #333;
      }
      .stats {
        font-size: 0.8em;
        color: #888;
      }
      #statusInfo {
        font-size: medium;
      }
    </style>
  </head>
  <body>
    <h2>üì° TRANSMISOR IA</h2>
    <video id="video" autoplay playsinline style="display: none"></video>
    <canvas id="canvas"></canvas>
    <div class="stats" id="info">
        <p id="statusInfo">Sin acceso por motivos de seguridad del navegador <br>
            En el navegador de tu tel√©fono, escribe: chrome://flags <br>
            Busca: "Insecure origins treated as secure". <br>
            Activa la opci√≥n (Enabled) y en el cuadro de texto escribe la IP y puerto del servidor: http://192.168.1.1:3000 (usa la IP del servidor). <br>
            Reinicia el navegador (bot√≥n Relaunch). <br>
            Vuelve a entrar a la p√°gina. Ahora deber√≠a pedirte permiso para usar la c√°mara.</p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const info = document.getElementById("info");
      const statusInfo = document.getElementById("statusInfo");

      // Configuraci√≥n de resoluci√≥n (640x480 es ideal para MediaPipe)
      const constraints = {
        video: { facingMode: "environment", width: 640, height: 480 },
        audio: false,
      };

      navigator.mediaDevices
        .getUserMedia(constraints)
        .then((stream) => {
          log("‚úÖ C√°mara accedida correctamente");
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            log("üé• Video cargado, iniciando transmisi√≥n...");
            enviarVideo();
          };
        })
        .catch((err) => {
          log("‚ùå ERROR de C√°mara: " + err.name + " - " + err.message);
          if (location.protocol !== "https:") {
            log("‚ö†Ô∏è El navegador bloquea la c√°mara por falta de HTTPS.");
          }
        });

      function enviarVideo() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Convertir a Blob (Binario) directamente para evitar el peso de Base64
          canvas.toBlob(
            (blob) => {
              socket.emit("video-frame", blob);
            },
            "image/jpeg",
            0.6
          ); // 0.6 es el balance perfecto calidad/peso
        }
        // Sincronizamos con el refresco de pantalla del tel√©fono (aprox 30-60fps)
        requestAnimationFrame(enviarVideo);
      }
      

      // Funci√≥n para imprimir logs en la pantalla del tel√©fono
      function log(msg) {
        const msgError = document.createElement("p");
        msgError.textContent = msg;
        info.appendChild(msgError);
        console.log(msg);
      }

      

      socket.on("connect", () => (statusInfo.innerText = "‚úÖ Conectado al servidor"));
    </script>
  </body>
</html>
